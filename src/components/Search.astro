---
// Heavy inspiration taken from Astro Starlight -> https://github.com/withastro/starlight/blob/main/packages/starlight/components/Search.astro

import "@pagefind/default-ui/css/ui.css";
import { Icon } from "astro-icon/components";
---

<div id="search" class="search-container">
	<div class="search-input-container">
		<input 
			type="text" 
			id="search-input" 
			placeholder="Rechercher..." 
			class="w-full p-2 rounded-md border border-special-lighter bg-special-lightest focus:outline-none focus:ring-2 focus:ring-accent-base"
		/>
	</div>
	<div id="search-results" class="search-results mt-4"></div>
</div>

<script>
	// Cette fonction s'exécute après le chargement de la page
	document.addEventListener('DOMContentLoaded', async () => {
		// Importation dynamique de Pagefind
		const { search } = await import('/pagefind/pagefind.js');
		
		const searchInput = document.getElementById('search-input');
		const searchResults = document.getElementById('search-results');
		
		if (!searchInput || !searchResults) return;
		
		let debounceTimeout;
		
		searchInput.addEventListener('input', (e) => {
			clearTimeout(debounceTimeout);
			
			const query = e.target.value;
			
			if (query.length < 3) {
				searchResults.innerHTML = '';
				return;
			}
			
			debounceTimeout = setTimeout(async () => {
				const results = await search.search(query);
				
				if (results.results.length === 0) {
					searchResults.innerHTML = '<p>Aucun résultat trouvé</p>';
					return;
				}
				
				const fragment = document.createDocumentFragment();
				
				for (const result of results.results) {
					const data = await result.data();
					
					const resultElement = document.createElement('div');
					resultElement.className = 'search-result p-3 rounded-md hover:bg-special-lighter mb-2';
					
					const titleElement = document.createElement('a');
					titleElement.href = data.url;
					titleElement.className = 'font-medium text-accent-two hover:underline';
					titleElement.textContent = data.meta.title;
					
					const excerptElement = document.createElement('p');
					excerptElement.className = 'text-sm mt-1';
					excerptElement.textContent = data.excerpt;
					
					resultElement.appendChild(titleElement);
					resultElement.appendChild(excerptElement);
					fragment.appendChild(resultElement);
				}
				
				searchResults.innerHTML = '';
				searchResults.appendChild(fragment);
			}, 300);
		});
	});
</script>

<style>
	.search-container {
		width: 100%;
		max-width: 600px;
		margin: 0 auto;
	}
	
	.search-results {
		max-height: 500px;
		overflow-y: auto;
	}
</style>